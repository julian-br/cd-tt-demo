---
export interface Props {
  src: string;
  class?: string;
  specPath?: string;
}
const { src, class: className, specPath } = Astro.props;
---

<div class:list={["flex items-center gap-x-3", className]}>
  <audio controls src={src} class="w-36 scale-80 origin-left -mr-9"></audio>
  {
    specPath && (
      <button
        type="button"
        class="view-spec-button hover:cursor-pointer whitespace-nowrap rounded-md bg-slate-100 px-2 py-2 text-xs font-semibold text-slate-700 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-200 transition-colors"
        data-spec-path={specPath}
      >
        View Spec
      </button>
    )
  }
</div>

<div
  class="spec-modal-container fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-6"
>
  <div class="relative w-full max-w-4xl h-[30vh]">
    <div
      class="spec-modal-content h-full w-full rounded-lg bg-white p-4 shadow-xl flex items-center justify-start overflow-x-auto"
    >
      <img src="" alt="Mel Spectrogram" class="spec-image h-full max-w-none" />
    </div>
    <button
      class="close-modal-button absolute -top-2 hover:cursor-pointer -right-2 z-10 rounded-full bg-slate-800 p-1 text-white hover:bg-slate-600"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><line x1="18" y1="6" x2="6" y2="18"></line><line
          x1="6"
          y1="6"
          x2="18"
          y2="18"></line></svg
      >
    </button>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("click", (event: MouseEvent) => {
      const button = (event.target as Element).closest<HTMLButtonElement>(
        ".view-spec-button"
      );
      if (!button) return;

      const specPath = button.dataset.specPath;
      const playerContainer = button.parentElement;
      const modal = playerContainer?.nextElementSibling as HTMLElement | null;
      const img = modal?.querySelector<HTMLImageElement>(".spec-image");
      const closeModalButton = modal?.querySelector<HTMLButtonElement>(
        ".close-modal-button"
      );

      if (!specPath || !modal || !img || !closeModalButton) return;

      img.src = specPath;
      modal.classList.remove("hidden");
      modal.classList.add("flex");

      const closeModal = () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        img.src = "";
      };

      const once = { once: true };
      closeModalButton.addEventListener("click", closeModal, once);
      modal.addEventListener(
        "click",
        (e: MouseEvent) => {
          if (e.target === modal) closeModal();
        },
        once
      );
    });
  });
</script>
